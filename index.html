<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CS Bot Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      height: 100vh;
      font-family: 'Orbitron', Arial, sans-serif;
      overflow-x: hidden;
      background: #000; /* fallback */
    }
    #bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
      opacity: 0.7;
      pointer-events: none;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      grid-template-rows: auto;
      gap: 32px;
      width: 100vw;
      max-width: 1200px;
      margin: 48px auto 32px auto;
      padding: 0 16px;
      box-sizing: border-box;
    }
    .dashboard-card {
      background: rgba(10, 15, 40, 0.85);
      border-radius: 20px;
      box-shadow: 0 0 40px 8px #00f0ff44, 0 0 0 2px #00f0ff55;
      padding: 32px 24px 24px 24px;
      border: 2px solid #00f0ff;
      backdrop-filter: blur(2px);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
      min-height: 120px;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      will-change: box-shadow, border, transform;
    }
    .dashboard-card:hover {
      box-shadow: 0 0 80px 24px #00f0ff99, 0 0 0 4px #00f0ff;
      border-color: #fff;
      transform: translateY(-6px) scale(1.03);
    }
    .dashboard-card h1 {
      font-size: 2.2rem;
      font-weight: 700;
      color: #00f0ff;
      margin-bottom: 24px;
      letter-spacing: 2px;
      text-align: center;
      text-shadow: 0 0 8px #00f0ff, 0 0 24px #00f0ff99;
    }
    .stat-card {
      background: rgba(20, 30, 60, 0.85);
      border-radius: 14px;
      box-shadow: 0 0 16px 2px #00f0ff33, 0 0 0 1.5px #00f0ff55;
      padding: 18px 12px;
      display: flex;
      align-items: center;
      gap: 18px;
      border: 1.5px solid #00f0ff;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      will-change: box-shadow, border, transform;
      width: 100%;
      margin-bottom: 16px;
    }
    .stat-card:last-child { margin-bottom: 0; }
    .stat-card:hover {
      box-shadow: 0 0 48px 12px #00f0ff99, 0 0 0 3px #00f0ff;
      border-color: #fff;
      transform: translateY(-4px) scale(1.025);
    }
    .stat-icon {
      font-size: 2.3rem;
      color: #00f0ff;
      width: 48px;
      text-align: center;
      filter: drop-shadow(0 0 8px #00f0ff);
    }
    .stat-info {
      display: flex;
      flex-direction: column;
    }
    .stat-title {
      font-size: 1.12rem;
      color: #b2f7ff;
      font-weight: 600;
      margin-bottom: 2px;
      letter-spacing: 1px;
      text-shadow: 0 0 4px #00f0ff99;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: 2px;
      text-shadow: 0 0 12px #00f0ff, 0 0 32px #00f0ff99;
    }
    .footer {
      text-align: center;
      margin-top: 18px;
      color: #b2f7ff;
      font-size: 1.05rem;
      text-shadow: 0 0 4px #00f0ff99;
    }
    .footer a {
      color: #00f0ff;
      text-decoration: none;
      transition: text-decoration 0.2s;
    }
    .footer a:hover {
      text-decoration: underline;
    }
    .error {
      color: #ff3c3c;
      font-size: 1.1rem;
      margin-top: 10px;
      text-align: center;
      text-shadow: 0 0 8px #ff3c3c99;
    }
    .charts-panel h2 {
      color: #b2f7ff;
      font-size: 1.1rem;
      text-shadow: 0 0 4px #00f0ff99;
      margin-bottom: 8px;
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 1px;
      text-align: center;
    }
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }
    @media (max-width: 500px) {
      .dashboard-card, .charts-panel { padding: 12px 2px 8px 2px; min-height: 0; }
      .dashboard-card h1 { font-size: 1.3rem; }
      .stat-card { padding: 12px 6px; }
      .stat-title { font-size: 0.98rem; }
      .stat-value { font-size: 1.3rem; }
    }
    .section-divider {
      width: 100vw;
      max-width: 1200px;
      margin: 0 auto 24px auto;
      padding: 0 16px;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .section-divider h2 {
      width: 100%;
      text-align: center;
      font-size: 2.1rem;
      font-weight: 800;
      color: #00f0ff;
      letter-spacing: 2px;
      margin: 0;
      padding: 18px 0 10px 0;
      border-radius: 18px;
      background: rgba(10, 15, 40, 0.92);
      box-shadow: 0 0 32px 8px #00f0ff44, 0 0 0 2.5px #00f0ff99;
      text-shadow: 0 0 16px #00f0ff, 0 0 32px #00f0ff99;
      border: 2.5px solid #00f0ff;
      position: relative;
      z-index: 2;
    }
    #category-section > div {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 32px 24px;
      width: 100%;
    }
    #category-section .category-card {
      background: rgba(10,15,40,0.92);
      border-radius: 18px;
      box-shadow: 0 0 24px 4px #00f0ff33, 0 0 0 2px #00f0ff55;
      border: 2px solid #00f0ff;
      padding: 28px 22px 18px 22px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      min-height: 160px;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      will-change: box-shadow, border, transform;
    }
    #category-section .category-card:hover {
      box-shadow: 0 0 48px 12px #00f0ff99, 0 0 0 3px #00f0ff;
      border-color: #fff;
      transform: translateY(-4px) scale(1.025);
    }
    #category-section .category-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #00f0ff;
      text-shadow: 0 0 8px #00f0ff,0 0 24px #00f0ff99;
      margin-bottom: 8px;
    }
    #category-section .category-count {
      font-size: 2.1rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: 2px;
      text-shadow: 0 0 12px #00f0ff, 0 0 32px #00f0ff99;
      margin-bottom: 10px;
    }
    #category-section ul {
      margin: 0 0 0 12px;
      padding: 0 0 0 0.5em;
      color: #b2f7ff;
      font-size: 1.05rem;
    }
    @media (max-width: 900px) {
      .section-divider h2 { font-size: 1.3rem; padding: 10px 0 6px 0; }
      #category-section > div { gap: 16px 8px; }
    }
    @media (max-width: 500px) {
      .section-divider h2 { font-size: 1.05rem; padding: 7px 0 4px 0; }
      #category-section > div { grid-template-columns: 1fr; gap: 10px 0; }
      #category-section .category-card { padding: 12px 6px; min-height: 0; }
    }
    #before-after-section {
      margin-top: 0;
    }
    .before-after-columns {
      align-items: stretch;
      display: flex;
      gap: 32px;
      width: 100%;
      justify-content: center;
      position: relative;
    }
    .before-after-divider {
      position: absolute;
      top: 0; bottom: 0;
      left: 50%;
      width: 0;
      z-index: 1;
      pointer-events: none;
    }
    .before-after-divider-line {
      position: absolute;
      left: -1px;
      top: 0; bottom: 0;
      width: 2.5px;
      background: linear-gradient(180deg, #00f0ff 0%, #00f0ff99 100%);
      box-shadow: 0 0 24px 6px #00f0ff66;
      border-radius: 2px;
      opacity: 0.85;
      height: 100%;
    }
    .before-after-col {
      flex: 1 1 0;
      min-width: 0;
      max-width: 50%;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .before-after-section-title {
      text-align: center;
      font-size: 1.25rem;
      color: #b2f7ff;
      margin-bottom: 18px;
      letter-spacing: 1px;
      font-weight: 700;
    }
    .before-after-card {
      background: rgba(10,15,40,0.92);
      border-radius: 18px;
      box-shadow: 0 0 24px 4px #00f0ff33, 0 0 0 2px #00f0ff55;
      border: 2px solid #00f0ff;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      will-change: box-shadow, border, transform;
      padding: 28px 18px 18px 18px;
      margin-bottom: 0;
    }
    .before-after-card:hover {
      box-shadow: 0 0 48px 12px #00f0ff99, 0 0 0 3px #00f0ff;
      border-color: #fff;
      transform: translateY(-4px) scale(1.025);
    }
    .before-after-category {
      font-size: 1.25rem;
      font-weight: 700;
      color: #00f0ff;
      text-shadow: 0 0 8px #00f0ff,0 0 24px #00f0ff99;
      letter-spacing: 1px;
      flex: 1 1 auto;
      white-space: pre-line;
      margin-right: 0.5em;
    }
    .before-after-count {
      font-size: 2.6rem;
      color: #fff;
      font-weight: 800;
      letter-spacing: 1.5px;
      text-shadow: 0 0 12px #00f0ff, 0 0 32px #00f0ff99;
      flex-shrink: 0;
      min-width: 48px;
      text-align: right;
      margin-left: 0.5em;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    .before-after-messages {
      margin: 0 0 0 12px;
      padding: 0 0 0 0.5em;
      color: #b2f7ff;
      font-size: 1.05rem;
    }
    @media (max-width: 900px) {
      .before-after-col { gap: 12px; }
      .before-after-card { padding: 14px 6px 10px 6px; }
      .before-after-category { font-size: 1.05rem; }
    }
    @media (max-width: 600px) {
      .before-after-columns {
        flex-direction: column;
        gap: 18px;
        align-items: stretch;
      }
      .before-after-col {
        max-width: 100%;
        width: 100%;
      }
      .before-after-divider { display: none; }
      .before-after-card-header {
        flex-direction: row;
        gap: 8px;
      }
      .before-after-category { font-size: 1rem; }
      .before-after-count { font-size: 1.5rem; min-width: 32px; }
      .before-after-card { padding: 10px 4px 8px 4px; }
      .dashboard-card h1 { font-size: 1.1rem; }
      .dashboard-card { padding: 8px 2px 8px 2px; min-height: 0; }
      .stat-card { padding: 8px 2px; margin-bottom: 8px; }
      .stat-title { font-size: 0.85rem; }
      .stat-value { font-size: 1.1rem; }
      .stat-icon { font-size: 1.3rem; width: 32px; }
      .stat-info { font-size: 0.95rem; }
      .section-divider h2 { font-size: 1rem; padding: 6px 0 2px 0; }
      .charts-panel h2 { font-size: 0.9rem; }
      .footer { font-size: 0.85rem; }
      .dashboard-card, .charts-panel { margin-bottom: 10px; }
      .dashboard-grid { gap: 10px; padding: 0 12px; }
      .section-divider, #before-after-section { padding-left: 12px !important; padding-right: 12px !important; }
      .dashboard-card, .charts-panel, .stat-card, .before-after-card { margin-left: 2px; margin-right: 2px; }
    }
    .before-after-arrow-col {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      max-width: 48px;
      padding: 0 8px;
      height: 100%;
    }
    .before-after-arrow-stack {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      height: 100%;
      min-height: 100%;
      pointer-events: none;
    }
    .before-after-arrow {
      font-size: 2.2rem;
      color: #00f0ff;
      text-shadow: 0 0 12px #00f0ff, 0 0 32px #00f0ff99;
      line-height: 1.1;
      user-select: none;
    }
    @media (max-width: 900px) {
      .before-after-arrow { font-size: 1.4rem; }
      .before-after-arrow-col { min-width: 18px; max-width: 24px; }
    }
    @media (max-width: 600px) {
      .before-after-arrow-col { display: none; }
    }
    .before-after-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 8px;
      gap: 0;
    }
    #quit-dashboard {
      margin-top: 0;
      margin-bottom: 32px;
    }
    .quit-summary-table {
      width: 100%;
      border-spacing: 0 12px;
      border-collapse: separate;
      margin: 0 auto 18px auto;
      color: #b2f7ff;
      font-size: 1.08rem;
    }
    .quit-summary-table th, .quit-summary-table td {
      padding: 8px 12px;
      text-align: left;
    }
    .quit-summary-table th {
      color: #00f0ff;
      font-size: 1.12rem;
      font-weight: 700;
      text-shadow: 0 0 8px #00f0ff,0 0 24px #00f0ff99;
    }
    .quit-summary-table tr {
      background: rgba(10,15,40,0.92);
      border-radius: 12px;
      box-shadow: 0 0 12px 2px #00f0ff33, 0 0 0 1.5px #00f0ff55;
      border: 1.5px solid #00f0ff;
    }
    #quitPie {
      width: 100%;
      max-width: 320px;
      display: block;
      margin: 0 auto 18px auto;
    }
    #quit-debug {
      margin-top: 0;
      margin-bottom: 32px;
      color: #b2f7ff;
      font-size: 0.98rem;
    }
    .quit-debug-table {
      width: 100%;
      border-spacing: 0 8px;
      border-collapse: separate;
      margin: 0 auto 12px auto;
      color: #b2f7ff;
      font-size: 0.98rem;
    }
    .quit-debug-table th, .quit-debug-table td {
      padding: 6px 10px;
      text-align: left;
      vertical-align: top;
    }
    .quit-debug-table th {
      color: #00f0ff;
      font-size: 1.05rem;
      font-weight: 700;
      text-shadow: 0 0 8px #00f0ff,0 0 24px #00f0ff99;
    }
    .quit-debug-table tr {
      background: rgba(10,15,40,0.92);
      border-radius: 8px;
      box-shadow: 0 0 8px 1px #00f0ff33, 0 0 0 1px #00f0ff55;
      border: 1px solid #00f0ff;
    }
    .quit-debug-step {
      color: #00f0ff;
      font-weight: 600;
    }
    .quit-debug-msg {
      color: #fff;
      font-size: 0.97rem;
      word-break: break-all;
    }
    .quit-slicer-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 18px 0 8px 0;
      justify-content: flex-start;
      align-items: center;
    }
    .quit-slicer-btn {
      background: linear-gradient(90deg, #0ff 0%, #4f8cff 100%);
      color: #001a2c;
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 1.15rem;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      box-shadow: 0 0 16px 2px #00f0ff33, 0 0 0 1.5px #00f0ff55;
      padding: 12px 24px 12px 18px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.13s, filter 0.18s;
      outline: none;
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .quit-slicer-btn:hover, .quit-slicer-btn.active {
      background: linear-gradient(90deg, #00f0ff 0%, #fff 100%);
      color: #001a2c;
      box-shadow: 0 0 32px 8px #00f0ffcc, 0 0 0 3px #00f0ff;
      transform: translateY(-2px) scale(1.04);
      filter: brightness(1.2) drop-shadow(0 0 16px #00f0ffcc);
    }
    .quit-slicer-btn.clear {
      background: linear-gradient(90deg, #222 0%, #444 100%);
      color: #b2f7ff;
      border: 1.5px solid #00f0ff;
      font-weight: 600;
      box-shadow: none;
      margin-left: 18px;
    }
    .quit-slicer-btn.clear:hover, .quit-slicer-btn.clear.active {
      background: linear-gradient(90deg, #00f0ff 0%, #fff 100%);
      color: #001a2c;
      border: 1.5px solid #fff;
    }
    .quit-slicer-count {
      background: #001a2c;
      color: #00f0ff;
      border-radius: 8px;
      padding: 2px 10px;
      font-size: 1.05rem;
      font-weight: 700;
      margin-left: 8px;
      box-shadow: 0 0 8px #00f0ff44;
    }
    .quit-card-ui {
      background: rgba(10, 15, 40, 0.92);
      border-radius: 22px;
      box-shadow: 0 0 40px 8px #00f0ff44, 0 0 0 2.5px #00f0ff99;
      border: 2.5px solid #00f0ff;
      padding: 32px 0 18px 0;
      margin: 0 auto 36px auto;
      max-width: 1240px;
      width: 100vw;
      position: relative;
      z-index: 2;
      transition: box-shadow 0.22s, border 0.22s, transform 0.18s;
      will-change: box-shadow, border, transform;
    }
    .quit-card-ui:hover {
      box-shadow: 0 0 80px 24px #00f0ff99, 0 0 0 4px #00f0ff;
      border-color: #fff;
      transform: translateY(-4px) scale(1.01);
    }
  </style>
</head>
<body>
  <video autoplay loop muted playsinline id="bg-video">
    <source src="0703.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <script>
    // Skip the first second to avoid black frame
    document.addEventListener('DOMContentLoaded', function() {
      var video = document.getElementById('bg-video');
      video.addEventListener('loadedmetadata', function() {
        if (video.currentTime < 1) {
          video.currentTime = 1;
        }
      });
    });
  </script>
  <div class="dashboard-grid">
    <div class="dashboard-card">
      <h1>CS Bot Analytics</h1>
      <div class="stat-card">
        <span class="stat-icon">üí¨</span>
        <div class="stat-info">
          <span class="stat-title">Total Messages Replied</span>
          <span class="stat-value" id="repliedCount">...</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">‚è±Ô∏è</span>
        <div class="stat-info">
          <span class="stat-title">Total Time Saved (hours)</span>
          <span class="stat-value" id="timeSaved">...</span>
          <span style="font-size:0.85rem;color:#b2f7ff;margin-top:2px;display:block;">
            <a href="https://www.helpscout.com/helpu/email-customer-service-whats-an-acceptable-reply-time/" target="_blank" style="color:#00f0ff;text-decoration:underline;">2 min per quick reply</a> &nbsp;|&nbsp;
            <a href="https://www.gorgias.com/blog/average-response-time" target="_blank" style="color:#00f0ff;text-decoration:underline;">5 min per booking/complex</a>
          </span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üë§</span>
        <div class="stat-info">
          <span class="stat-title">Total Unique Customers</span>
          <span class="stat-value" id="uniqueCustomers">...</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">‚úÖ</span>
        <div class="stat-info">
          <span class="stat-title">Total Bookings Finished</span>
          <span class="stat-value" id="bookingsFinished">...</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üü¢</span>
        <div class="stat-info">
          <span class="stat-title">Active Users (24h / 7d / 30d)</span>
          <span class="stat-value" id="activeUsers">... / ... / ...</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üìà</span>
        <div class="stat-info">
          <span class="stat-title">Booking Conversion Rate</span>
          <span class="stat-value" id="conversionRate">...</span>
          <span style="font-size:0.95rem;color:#b2f7ff;margin-top:2px;display:block;">Of everyone who pressed üóì Book a Girl, this is the percent who finished a booking.</span>
        </div>
      </div>
      <div class="footer">
        Data from <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQxn3XKXCyfhssB2-W04zzeTE31RQNa9AGKJbwwUG8IdMEop4dzwTPe1A4-MoId7DcDvYGQJY3NDcME/pub?gid=0&single=true&output=csv" target="_blank">Google Sheet</a>
      </div>
      <div class="error" id="errorMsg"></div>
    </div>
    <div class="dashboard-card charts-panel">
      <h2>Peak Activity by Hour</h2>
      <div id="hourlyChart" style="width:100%;height:120px;"></div>
      <h2 style="margin-top:24px;">Messages by Weekday</h2>
      <div id="weekdayChart" style="width:100%;height:120px;"></div>
      <h2 style="margin-top:24px;">Messages by Day (Last 30 Days)</h2>
      <div id="dailyChart" style="width:100%;height:120px;"></div>
      <h2 style="margin-top:24px;">Most Frequent Customer Request</h2>
      <canvas id="conversionPie" width="220" height="120" style="width:100%;max-width:220px;display:block;margin:0 auto;"></canvas>
    </div>
  </div>
  <div class="section-divider">
    <h2>Where Customers Quit Booking</h2>
  </div>
  <div style="width:100vw;max-width:1200px;margin:0 auto 0 auto;padding:0 16px 0 16px;box-sizing:border-box;display:flex;justify-content:center;align-items:center;">
    <canvas id="quitPieLarge" width="600" height="320" style="width:100%;max-width:600px;min-height:320px;display:block;margin:0 auto 8px auto;"></canvas>
  </div>
  <div id="quit-dashboard" style="width:100vw;max-width:1200px;margin:0 auto 24px auto;padding:0 16px;box-sizing:border-box;"></div>
  <div id="quit-debug" style="width:100vw;max-width:1200px;margin:0 auto 24px auto;padding:0 16px;box-sizing:border-box;"></div>
  <div class="section-divider">
    <h2>Frequent Customer Messages <br>Before vs After CS Bot Update</h2>
  </div>
  <div id="before-after-section" style="width:100vw;max-width:1200px;margin:0 auto 48px auto;padding:0 16px;box-sizing:border-box;"></div>
  <script>
    // Direct CSV links for each sheet
    const normalMessagesUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxn3XKXCyfhssB2-W04zzeTE31RQNa9AGKJbwwUG8IdMEop4dzwTPe1A4-MoId7DcDvYGQJY3NDcME/pub?gid=0&single=true&output=csv';
    const bookingConfirmationUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxn3XKXCyfhssB2-W04zzeTE31RQNa9AGKJbwwUG8IdMEop4dzwTPe1A4-MoId7DcDvYGQJY3NDcME/pub?gid=237119173&single=true&output=csv';

    function parseCSV(text) {
      // Simple CSV parser for this use case
      const lines = text.split('\n').filter(Boolean);
      return lines.map(line => {
        // Handle quoted commas
        const cells = [];
        let cell = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cells.push(cell);
            cell = '';
          } else {
            cell += char;
          }
        }
        cells.push(cell);
        return cells;
      });
    }

    // --- Helper: Parse timestamp in both formats ---
    function parseTimestamp(ts) {
      if (!ts) return null;
      // Try ISO format first
      let d = Date.parse(ts);
      if (!isNaN(d)) return new Date(d);
      // Try 'YYYY/MM/DD HH:mm:ss' format
      const match = ts.match(/(\d{4})[\/-](\d{2})[\/-](\d{2})[ T](\d{1,2}):(\d{2})(?::(\d{2}))?/);
      if (match) {
        const [_, y, m, d2, h, min, s] = match;
        // Always treat as JST (UTC+9)
        const year = Number(y);
        const month = Number(m) - 1;
        const day = Number(d2);
        const hour = Number(h);
        const minute = Number(min);
        const second = s ? Number(s) : 0;
        // Create a Date as if it's UTC, then subtract 9 hours to get UTC time
        const utc = Date.UTC(year, month, day, hour - 9, minute, second);
        return new Date(utc);
      }
      return null;
    }

    // --- Visualization helpers (modern colors, upward bars, improved labels) ---
    function renderBarChart(containerId, data, labels, color, options = {}) {
      const max = Math.max(...data, 1);
      const barWidth = 100 / data.length;
      const showEvery = options.showEvery || 1;
      const rotateLabels = options.rotateLabels || false;
      const fontSize = options.fontSize || '0.8rem';
      const labelColor = options.labelColor || '#b2b7c6';
      const labelBelow = options.labelBelow || false;
      const bars = data.map((v, i) => {
        const showLabel = i % showEvery === 0;
        return `
          <div style="display:inline-block;width:${barWidth}%;height:100%;vertical-align:bottom;">
            <div style="height:${(v / max) * 90}%;background:${color};border-radius:4px 4px 0 0;box-shadow:0 2px 8px ${color}33;"></div>
            ${labelBelow ? '' : `<div style=\"text-align:center;font-size:${fontSize};color:${labelColor};margin-top:2px;${rotateLabels && showLabel ? 'transform:rotate(-35deg);' : ''}white-space:nowrap;overflow:visible;\">${showLabel ? labels[i] : ''}</div>`}
          </div>
        `;
      }).join('');
      let labelRow = '';
      if (labelBelow) {
        labelRow = `<div style='display:flex;align-items:flex-start;margin-top:6px;'>` +
          data.map((_, i) => {
            const showLabel = i % showEvery === 0;
            return `<div style='width:${barWidth}%;text-align:center;font-size:${fontSize};color:${labelColor};${rotateLabels && showLabel ? 'transform:rotate(-35deg);' : ''}white-space:nowrap;overflow:visible;'>${showLabel ? labels[i] : ''}</div>`;
          }).join('') + '</div>';
      }
      document.getElementById(containerId).innerHTML = `<div style='height:90px;display:flex;align-items:flex-end;'>${bars}</div>${labelRow}`;
    }

    // --- Draw Most Frequent Messages Pie Chart ---
    function drawMessagesPie(messageCounts, total) {
      const canvas = document.getElementById('conversionPie');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (total === 0) return;
      const cx = canvas.width / 2, cy = canvas.height / 2 - 8, r = 48;
      let start = -Math.PI / 2;
      const colors = ['#4f8cff', '#ffb347', '#7ed957', '#e0e7ef', '#ff6f91', '#6fafff', '#b2b7c6'];
      let i = 0;
      let legend = [];
      for (const {label, count} of messageCounts) {
        const angle = (count / total) * 2 * Math.PI;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + angle);
        ctx.closePath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.shadowColor = colors[i % colors.length] + '99';
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.restore();
        legend.push({color: colors[i % colors.length], label, count, percent: ((count/total)*100).toFixed(1)});
        start += angle;
        i++;
      }
      // White border
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, 2 * Math.PI);
      ctx.lineWidth = 2.5;
      ctx.strokeStyle = '#b2b7c6';
      ctx.shadowColor = '#4f8cff44';
      ctx.shadowBlur = 6;
      ctx.stroke();
      ctx.shadowBlur = 0;
      // Legend below chart
      let legendHtml = `<div style='display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin-top:8px;font-size:0.85rem;color:#fff;'>`;
      legend.forEach((item, idx) => {
        legendHtml += `<span style='display:flex;align-items:center;gap:4px;'><span style='display:inline-block;width:12px;height:12px;border-radius:50%;background:${item.color};'></span>${item.label.length > 18 ? item.label.slice(0,15)+'‚Ä¶' : item.label} <span style='color:#b2f7ff;margin-left:2px;'>${item.percent}%</span></span>`;
      });
      legendHtml += '</div>';
      canvas.nextElementSibling && (canvas.nextElementSibling.outerHTML = '');
      canvas.insertAdjacentHTML('afterend', legendHtml);
    }

    // --- Fetch normal messages for replied/unique and new analytics ---
    fetch(normalMessagesUrl)
      .then(res => res.text())
      .then(csvText => {
        const rows = parseCSV(csvText);
        if (rows.length < 2) throw new Error('No data found in normal messages');
        const header = rows[0];
        const colIdx = {
          userId: header.findIndex(h => h.trim().toLowerCase() === 'user id'),
          user: header.findIndex(h => h.trim().toLowerCase() === 'user'),
          response: header.findIndex(h => h.trim().toLowerCase() === 'response'),
          timestamp: header.findIndex(h => h.trim().toLowerCase() === 'timestamp'),
          messageContent: header.findIndex(h => h.trim().toLowerCase() === 'message content'),
        };
        const dataRows = rows.slice(1);

        // Total messages replied: count only rows with correct columns and non-empty message content
        const validRows = dataRows.filter(row => row.length === header.length && row[colIdx.messageContent] && row[colIdx.messageContent].trim() !== '');
        const repliedCount = validRows.length;

        // Total unique customers: unique user id or user
        const uniqueUsers = new Set();
        dataRows.forEach(row => {
          let uid = row[colIdx.userId];
          if (!uid || uid.trim() === '') {
            uid = row[colIdx.user];
          }
          if (uid && uid.trim() !== '') uniqueUsers.add(uid.trim());
        });

        // --- Active Users ---
        const now = new Date();
        const users24h = new Set();
        const users7d = new Set();
        const users30d = new Set();
        dataRows.forEach(row => {
          let uid = row[colIdx.userId];
          if (!uid || uid.trim() === '') {
            uid = row[colIdx.user];
          }
          const ts = parseTimestamp(row[colIdx.timestamp]);
          if (!uid || !ts) return;
          const diffMs = now - ts;
          if (diffMs >= 0 && diffMs < 24 * 60 * 60 * 1000) {
            users24h.add(uid);
          }
          if (diffMs >= 0 && diffMs < 7 * 24 * 60 * 60 * 1000) users7d.add(uid);
          if (diffMs >= 0 && diffMs < 30 * 24 * 60 * 60 * 1000) users30d.add(uid);
        });
        document.getElementById('activeUsers').textContent = `${users24h.size} / ${users7d.size} / ${users30d.size}`;

        // --- Peak Activity by Hour ---
        const hours = Array(24).fill(0);
        const weekdays = Array(7).fill(0);
        const dailyCounts = {};
        dataRows.forEach(row => {
          const ts = parseTimestamp(row[colIdx.timestamp]);
          if (!ts) return;
          hours[ts.getHours()]++;
          weekdays[ts.getDay()]++;
          // For daily chart (YYYY-MM-DD)
          const dayKey = ts.getFullYear() + '-' + String(ts.getMonth()+1).padStart(2,'0') + '-' + String(ts.getDate()).padStart(2,'0');
          dailyCounts[dayKey] = (dailyCounts[dayKey] || 0) + 1;
        });
        renderBarChart('hourlyChart', hours, Array.from({length:24}, (_,i)=>i), '#4f8cff', {fontSize:'0.75rem', labelColor:'#b2b7c6'});
        renderBarChart('weekdayChart', weekdays, ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], '#ffb347', {fontSize:'0.8rem', labelColor:'#b2b7c6'});
        // --- Messages by Day (last 30 days) ---
        const last30Days = [];
        const last30Labels = [];
        for (let i = 29; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
          const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
          last30Labels.push((d.getMonth()+1) + '/' + d.getDate());
          last30Days.push(dailyCounts[key] || 0);
        }
        renderBarChart('dailyChart', last30Days, last30Labels, '#7ed957', {showEvery:7, fontSize:'0.7rem', labelColor:'#b2b7c6', rotateLabels:true, labelBelow:true});

        // --- Most Frequent Messages Pie ---
        const bookingIntents = [
          'üí∞ Check Pricing',
          'üíå Option Pricing',
          'üóì Book a Girl',
          '‚ö†Ô∏è Important Rules',
          'üë© Talk to Real Staff',
          'üíï How it Works',
          'üö® Start from Beginning'
        ];
        const msgCounts = {};
        const bookingIntentUsers = new Set();
        let quickReplyCount = 0;
        let complexCount = 0;
        let bookAGirlCount = 0;
        dataRows.forEach(row => {
          const msg = (row[colIdx.messageContent] || '').trim();
          let uid = row[colIdx.userId];
          if (!uid || uid.trim() === '') {
            uid = row[colIdx.user];
          }
          if (!msg) return;
          if (msg === 'üóì Book a Girl') {
            bookAGirlCount++;
          }
          if (bookingIntents.includes(msg)) {
            msgCounts[msg] = (msgCounts[msg] || 0) + 1;
            if (uid && uid.trim() !== '') bookingIntentUsers.add(uid.trim());
            quickReplyCount++;
          } else {
            complexCount++;
          }
        });
        window.__bookAGirlCount = bookAGirlCount;
        // Only include the 7 booking intent messages, in the specified order
        const pieMsgs = bookingIntents
          .filter(label => msgCounts[label])
          .map(label => ({label, count: msgCounts[label]}));
        const totalPie = pieMsgs.reduce((sum, m) => sum + m.count, 0);
        drawMessagesPie(pieMsgs, totalPie);

        document.getElementById('repliedCount').textContent = repliedCount;
        // Calculate and display total time saved (2 min per quick reply, 5 min per complex), show in hours
        const timeSavedMin = (quickReplyCount * 2) + (complexCount * 5);
        const timeSavedHours = (timeSavedMin / 60).toFixed(1);
        document.getElementById('timeSaved').textContent = timeSavedHours;
        document.getElementById('uniqueCustomers').textContent = uniqueUsers.size;
        updateConversionRateKPI();
      })
      .catch(err => {
        document.getElementById('repliedCount').textContent = 'Error';
        document.getElementById('uniqueCustomers').textContent = 'Error';
        document.getElementById('activeUsers').textContent = 'Error';
        document.getElementById('hourlyChart').innerHTML = '';
        document.getElementById('weekdayChart').innerHTML = '';
        document.getElementById('dailyChart').innerHTML = '';
        document.getElementById('errorMsg').textContent = 'Failed to load normal messages: ' + err.message;
      });

    // --- Fetch booking confirmation for bookings finished and conversion rate ---
    fetch(bookingConfirmationUrl)
      .then(res => res.text())
      .then(csvText => {
        const rows = parseCSV(csvText);
        // Subtract 1 for header row
        const bookingsFinished = Math.max(0, rows.length - 1);
        document.getElementById('bookingsFinished').textContent = bookingsFinished;
        // Store for conversion rate calculation
        window.__bookingsFinished = bookingsFinished;
        updateConversionRateKPI();
      })
      .catch(err => {
        document.getElementById('bookingsFinished').textContent = 'Error';
        document.getElementById('conversionRate').textContent = 'Error';
        document.getElementById('errorMsg').textContent = 'Failed to load booking confirmations: ' + err.message;
      });

    // --- Helper to update conversion rate KPI ---
    function updateConversionRateKPI() {
      const bookAGirlCount = window.__bookAGirlCount;
      const bookingsFinished = window.__bookingsFinished;
      if (typeof bookAGirlCount === 'number' && typeof bookingsFinished === 'number') {
        const rate = bookAGirlCount ? ((bookingsFinished / bookAGirlCount) * 100).toFixed(1) : '0.0';
        document.getElementById('conversionRate').textContent = `${rate}%`;
      }
    }

    // --- Render before/after CS bot update comparison ---
    function renderBeforeAfterSection(data) {
      // Separate before and after arrays, sort by count descending
      const before = data.filter(row => row["before the CS bot update or not"] === "before update").sort((a,b)=>b.count-a.count);
      const after = data.filter(row => row["before the CS bot update or not"] === "after update").sort((a,b)=>b.count-a.count);
      // Determine the max number of cards to set arrow stack height
      const maxCards = Math.max(before.length, after.length, 6);
      let html = `<div class='before-after-columns'>`;
      html += `<div class='before-after-col'><div class='before-after-section-title'>Before Update</div>`;
      before.forEach(row => {
        html += `<div class='before-after-card'>
          <div class='before-after-card-header'>
            <span class='before-after-category'>${row.category}</span>
            <span class='before-after-count'>${row.count}</span>
          </div>
          <ul class='before-after-messages'>${row["top messages"].split('\n').map(msg => `<li>${msg}</li>`).join('')}</ul>
        </div>`;
      });
      html += `</div>`;
      // Vertical divider
      html += `<div class='before-after-divider'><div class='before-after-divider-line'></div></div>`;
      html += `<div class='before-after-col'><div class='before-after-section-title'>After Update</div>`;
      after.forEach(row => {
        html += `<div class='before-after-card'>
          <div class='before-after-card-header'>
            <span class='before-after-category'>${row.category}</span>
            <span class='before-after-count'>${row.count}</span>
          </div>
          <ul class='before-after-messages'>${row["top messages"].split('\n').map(msg => `<li>${msg}</li>`).join('')}</ul>
        </div>`;
      });
      html += `</div></div>`;
      document.getElementById('before-after-section').innerHTML = html;
    }

    fetch('https://tokyogirlshub.app.n8n.cloud/webhook/cf41059f-1fb8-470e-b910-c554b70bc392')
      .then(res => res.json())
      .then(data => renderBeforeAfterSection(data))
      .catch(() => {
        document.getElementById('before-after-section').innerHTML = '';
      });

    // --- Robust step detection for quit analysis ---
    function detectQuitPoint(messages) {
      // Steps in order, with robust regex/partial matching
      const steps = [
        { key: 'book', label: 'Book a Girl', match: m => /book a girl|üóì/i.test(m) },
        { key: 'select', label: 'Girl/Schedule Selected', match: m => /girl selected|üíï|schedule selected|üìÖ/i.test(m) },
        { key: 'girl', label: 'Girl Name Chosen', match: m => /girl chosen:|ako|momo|serena|yano kanon|[a-z]{3,} (chan|san)?|girl name/i.test(m) },
        { key: 'visitdate', label: 'Visiting Date Chosen', match: m => /visiting date:\s*\d{4}-\d{2}-\d{2}/i.test(m) },
        { key: 'datecourse', label: 'Date & Course Selection', match: m => /chosen date&time:|course:|time:|\d{4}-\d{2}-\d{2}\s*\d{1,2}:\d{2}/i.test(m) },
        { key: 'option', label: 'Option Chosen', match: m => /optional services|no option|option|\[.*?\]|\{.*?\}|„Ç™„Éó„Ç∑„Éß„É≥|ÊåáÂêç|premium|special|add|extra|vibrator|filming|masturbation/i.test(m) },
        { key: 'confirm', label: 'Confirm', match: m => /confirmed\?:\s*(true|false)|confirm|ok|‰∫àÁ¥Ñ|Á¢∫ÂÆö|Ê±∫ÂÆö|ÂÆå‰∫Ü|submit|send|done/i.test(m) }
      ];
      // --- New: Special case for lost at 2 options ---
      const last2 = messages.slice(-2);
      const isGirl = /girl selected|üíï/i.test(last2[0]) || /girl selected|üíï/i.test(last2[1]);
      const isSched = /schedule selected|üìÖ/i.test(last2[0]) || /schedule selected|üìÖ/i.test(last2[1]);
      if (last2.length === 2 && isGirl && isSched) {
        // Make sure these are the last two messages (no other after)
        return 'Lost at 2 options';
      }
      // --- New: Split confirm into succeeded/failed ---
      if (messages.length && /confirmed\?:\s*true/i.test(messages[messages.length-1])) {
        return 'Confirm Succeeded';
      }
      if (messages.length && /confirmed\?:\s*false/i.test(messages[messages.length-1])) {
        return 'Confirm Failed';
      }
      // --- New: Split Girl/Schedule Selected ---
      if (messages.length && /girl selected|üíï/i.test(messages[messages.length-1])) {
        return 'Girl Selected';
      }
      if (messages.length && /schedule selected|üìÖ/i.test(messages[messages.length-1])) {
        return 'Schedule Selected';
      }
      // If the last message matches confirm, always return 'Confirm'
      if (messages.length && steps[steps.length-1].match(messages[messages.length-1])) {
        return steps[steps.length-1].label;
      }
      return steps.reduce((acc, step, idx) => step.match(messages[messages.length-1]) ? step.label : acc, null) || (steps.find((_,i)=>messages.some(m=>steps[i].match(m)))?.label || 'Other');
    }

    // --- Improved booking attempt grouping by user and session ---
    function renderQuitDashboard(dataRows, colIdx) {
      // For debug: store all attempts and quit points
      const debugAttempts = [];
      // Group messages by chat id (column D)
      const chatIdIdx = colIdx.chatId !== undefined ? colIdx.chatId : 3;
      const chatMap = {};
      dataRows.forEach(row => {
        const chatId = row[chatIdIdx];
        if (!chatId) return;
        if (!chatMap[chatId]) chatMap[chatId] = [];
        chatMap[chatId].push(row);
      });
      // Only include chat ids that have at least one 'üóì Book a Girl' message
      const filteredChatMap = {};
      Object.entries(chatMap).forEach(([cid, msgs]) => {
        if (msgs.some(r => (r[colIdx.messageContent]||'').includes('üóì Book a Girl'))) {
          filteredChatMap[cid] = msgs;
        }
      });
      // For each user, find booking attempts (start with Book a Girl), group by session (timestamp gap > 30min)
      const quitCounts = {};
      Object.entries(filteredChatMap).forEach(([cid, msgs]) => {
        // Sort by timestamp if available
        msgs.sort((a,b)=>{
          const ta = a[colIdx.timestamp], tb = b[colIdx.timestamp];
          return ta && tb ? ta.localeCompare(tb) : 0;
        });
        let attempt = [];
        let lastTs = null;
        for (let i = 0; i < msgs.length; i++) {
          const m = msgs[i][colIdx.messageContent] || '';
          const ts = msgs[i][colIdx.timestamp];
          // If >30min gap, treat as new session
          if (lastTs && ts) {
            const t1 = new Date(lastTs).getTime(), t2 = new Date(ts).getTime();
            if (!isNaN(t1) && !isNaN(t2) && t2-t1 > 30*60*1000 && attempt.length) {
              // --- NEW: Only keep session if it contains a booking flow step ---
              const hasBookingStep = attempt.some(r => {
                const msg = (r[colIdx.messageContent]||'');
                return /üóì|book a girl|üíï|girl selected|üìÖ|schedule selected/i.test(msg);
              });
              if (hasBookingStep) {
                const quit = detectQuitPoint(attempt.map(r=>r[colIdx.messageContent]||''));
                // Find the first valid customer message row in the attempt
                const firstValid = attempt.find(r => {
                  const u = r[colIdx.user];
                  const t = r[colIdx.timestamp];
                  if (!u || typeof u !== 'string') return false;
                  const uLower = u.toLowerCase();
                  if (uLower.includes('please come to our booth') || uLower.startsWith('/start') || uLower.includes('auto assistant')) return false;
                  if (!t || typeof t !== 'string' || isNaN(Date.parse(t))) return false;
                  return true;
                });
                if (firstValid) {
                  const lastMsg = (attempt[attempt.length-1][colIdx.messageContent]||'').trim();
                  // Filtering logic (same as debug table)
                  const ignored = [
                    'üë© Talk to Real Staff',
                    'üíå Option Pricing',
                    'üí∞ Check Pricing',
                    'üíï How it Works',
                    '‚ö†Ô∏è Important Rules',
                    'üö® Start from Beginning',
                    '/start'
                  ];
                  if (!ignored.includes(lastMsg)) {
                    // Special quit step filtering
                    let valid = true;
                    if (quit === 'Book a Girl' && lastMsg !== 'üóì Book a Girl') valid = false;
                    if (quit === 'Confirm Succeeded' && !/confirmed\?:\s*true/i.test(lastMsg)) valid = false;
                    if (quit === 'Confirm Failed' && !/confirmed\?:\s*false/i.test(lastMsg)) valid = false;
                    if (quit === 'Girl Selected' && !/girl selected|üíï/i.test(lastMsg)) valid = false;
                    if (quit === 'Schedule Selected' && !/schedule selected|üìÖ/i.test(lastMsg)) valid = false;
                    if (quit === 'Lost at 2 options' && quit !== 'Lost at 2 options') valid = false;
                    if (valid) {
                      quitCounts[quit] = (quitCounts[quit]||0)+1;
                      debugAttempts.push({
                        uid: firstValid[colIdx.user],
                        chatId: cid,
                        ts: firstValid[colIdx.timestamp],
                        quit,
                        lastMsg
                      });
                    }
                  }
                }
              }
              attempt = [];
            }
          }
          if (/book a girl|üóì/i.test(m) && attempt.length) {
            // New booking attempt
            const hasBookingStep = attempt.some(r => {
              const msg = (r[colIdx.messageContent]||'');
              return /üóì|book a girl|üíï|girl selected|üìÖ|schedule selected/i.test(msg);
            });
            if (hasBookingStep) {
              const quit = detectQuitPoint(attempt.map(r=>r[colIdx.messageContent]||''));
              // Find the first valid customer message row in the attempt
              const firstValid = attempt.find(r => {
                const u = r[colIdx.user];
                const t = r[colIdx.timestamp];
                if (!u || typeof u !== 'string') return false;
                const uLower = u.toLowerCase();
                if (uLower.includes('please come to our booth') || uLower.startsWith('/start') || uLower.includes('auto assistant')) return false;
                if (!t || typeof t !== 'string' || isNaN(Date.parse(t))) return false;
                return true;
              });
              if (firstValid) {
                const lastMsg = (attempt[attempt.length-1][colIdx.messageContent]||'').trim();
                // Filtering logic (same as debug table)
                const ignored = [
                  'üë© Talk to Real Staff',
                  'üíå Option Pricing',
                  'üí∞ Check Pricing',
                  'üíï How it Works',
                  '‚ö†Ô∏è Important Rules',
                  'üö® Start from Beginning',
                  '/start'
                ];
                if (!ignored.includes(lastMsg)) {
                  let valid = true;
                  if (quit === 'Book a Girl' && lastMsg !== 'üóì Book a Girl') valid = false;
                  if (quit === 'Confirm Succeeded' && !/confirmed\?:\s*true/i.test(lastMsg)) valid = false;
                  if (quit === 'Confirm Failed' && !/confirmed\?:\s*false/i.test(lastMsg)) valid = false;
                  if (quit === 'Girl Selected' && !/girl selected|üíï/i.test(lastMsg)) valid = false;
                  if (quit === 'Schedule Selected' && !/schedule selected|üìÖ/i.test(lastMsg)) valid = false;
                  if (quit === 'Lost at 2 options' && quit !== 'Lost at 2 options') valid = false;
                  if (valid) {
                    quitCounts[quit] = (quitCounts[quit]||0)+1;
                    debugAttempts.push({
                      uid: firstValid[colIdx.user],
                      chatId: cid,
                      ts: firstValid[colIdx.timestamp],
                      quit,
                      lastMsg
                    });
                  }
                }
              }
            }
            attempt = [];
          }
          attempt.push(msgs[i]);
          lastTs = ts;
        }
        if (attempt.length) {
          const hasBookingStep = attempt.some(r => {
            const msg = (r[colIdx.messageContent]||'');
            return /üóì|book a girl|üíï|girl selected|üìÖ|schedule selected/i.test(msg);
          });
          if (hasBookingStep) {
            const quit = detectQuitPoint(attempt.map(r=>r[colIdx.messageContent]||''));
            // Find the first valid customer message row in the attempt
            const firstValid = attempt.find(r => {
              const u = r[colIdx.user];
              const t = r[colIdx.timestamp];
              if (!u || typeof u !== 'string') return false;
              const uLower = u.toLowerCase();
              if (uLower.includes('please come to our booth') || uLower.startsWith('/start') || uLower.includes('auto assistant')) return false;
              if (!t || typeof t !== 'string' || isNaN(Date.parse(t))) return false;
              return true;
            });
            if (firstValid) {
              const lastMsg = (attempt[attempt.length-1][colIdx.messageContent]||'').trim();
              // Filtering logic (same as debug table)
              const ignored = [
                'üë© Talk to Real Staff',
                'üíå Option Pricing',
                'üí∞ Check Pricing',
                'üíï How it Works',
                '‚ö†Ô∏è Important Rules',
                'üö® Start from Beginning',
                '/start'
              ];
              if (!ignored.includes(lastMsg)) {
                let valid = true;
                if (quit === 'Book a Girl' && lastMsg !== 'üóì Book a Girl') valid = false;
                if (quit === 'Confirm Succeeded' && !/confirmed\?:\s*true/i.test(lastMsg)) valid = false;
                if (quit === 'Confirm Failed' && !/confirmed\?:\s*false/i.test(lastMsg)) valid = false;
                if (quit === 'Girl Selected' && !/girl selected|üíï/i.test(lastMsg)) valid = false;
                if (quit === 'Schedule Selected' && !/schedule selected|üìÖ/i.test(lastMsg)) valid = false;
                if (quit === 'Lost at 2 options' && quit !== 'Lost at 2 options') valid = false;
                if (valid) {
                  quitCounts[quit] = (quitCounts[quit]||0)+1;
                  debugAttempts.push({
                    uid: firstValid[colIdx.user],
                    chatId: cid,
                    ts: firstValid[colIdx.timestamp],
                    quit,
                    lastMsg
                  });
                }
              }
            }
          }
        }
      });
      // Prepare data for bar chart and table, EXCLUDE 'Other' and 'Confirm'
      let quitLabels = Object.keys(quitCounts).filter(l => l !== 'Other' && l !== 'Confirm');
      // Ensure Confirm Succeeded and Confirm Failed are next to each other and in order
      const confirmIdx = quitLabels.findIndex(l => l === 'Confirm Succeeded');
      const confirmFailIdx = quitLabels.findIndex(l => l === 'Confirm Failed');
      if (confirmIdx !== -1 && confirmFailIdx !== -1 && Math.abs(confirmIdx - confirmFailIdx) !== 1) {
        // Remove both and re-insert them next to each other at the earlier index
        const minIdx = Math.min(confirmIdx, confirmFailIdx);
        quitLabels = quitLabels.filter(l => l !== 'Confirm Succeeded' && l !== 'Confirm Failed');
        quitLabels.splice(minIdx, 0, 'Confirm Succeeded', 'Confirm Failed');
      }
      const quitData = quitLabels.map(l=>quitCounts[l]);
      // Bar chart
      drawQuitBar(quitLabels, quitData);
      // Table (now slicer)
      let slicerHtml = `<div class='quit-slicer-container'>`;
      quitLabels.forEach((l,i)=>{
        slicerHtml += `<button class='quit-slicer-btn' data-step="${encodeURIComponent(l)}">${l} <span class='quit-slicer-count'>${quitData[i]}</span></button>`;
      });
      slicerHtml += `<button class='quit-slicer-btn clear' id='quitSlicerClear' style='margin-left:18px;'>Show All</button></div>`;
      document.getElementById('quit-dashboard').innerHTML = `<canvas id='quitPie' width='220' height='120'></canvas>`+slicerHtml;
      // Debug table (unchanged, but will filter)
      let debugHtml = `<table class='quit-debug-table' id='quitDebugTable'><tr><th>User</th><th>Chat ID</th><th>Start Time</th><th>Quit Step</th><th>Last Message</th></tr>`;
      const ignoreMsgs = [
        '/start',
        'üíï How it Works',
        '‚ö†Ô∏è Important Rules',
        'üíå Option Pricing',
        'üë© Talk to Real Staff',
        'üö® Start from Beginning',
        'üí∞ Check Pricing'
      ];
      const byChat = {};
      debugAttempts.forEach(a => {
        if (!byChat[a.chatId]) byChat[a.chatId] = [];
        byChat[a.chatId].push(a);
      });
      let debugRows = [];
      Object.values(byChat).forEach(attempts => {
        attempts.sort((a, b) => new Date(a.ts) - new Date(b.ts));
        let lastShown = null;
        for (let i = 0; i < attempts.length; i++) {
          const curr = attempts[i];
          const currTime = new Date(curr.ts).getTime();
          const next = attempts[i+1];
          const nextTime = next ? new Date(next.ts).getTime() : null;
          if (!next || (nextTime - currTime > 24*60*60*1000)) {
            debugRows.push(curr);
          }
        }
      });
      function renderDebugTable(filterStep) {
        let html = `<table class='quit-debug-table' id='quitDebugTable'><tr><th>User</th><th>Chat ID</th><th>Start Time</th><th>Quit Step</th><th>Last Message</th></tr>`;
        debugRows.forEach(row => {
          // Exclude rows with ignored lastMsg
          const ignored = [
            'üë© Talk to Real Staff',
            'üíå Option Pricing',
            'üí∞ Check Pricing',
            'üíï How it Works',
            '‚ö†Ô∏è Important Rules',
            'üö® Start from Beginning',
            '/start'
          ];
          const lastMsg = (row.lastMsg||'').trim();
          if (ignored.includes(lastMsg)) return;
          // Don't show Lost at 2 options in Girl/Schedule Selected
          if ((filterStep === 'Girl Selected' || filterStep === 'Schedule Selected') && row.quit === 'Lost at 2 options') return;
          if (filterStep === 'Book a Girl') {
            if (lastMsg !== 'üóì Book a Girl') return;
          } else if (filterStep === 'Confirm Succeeded') {
            if (!/confirmed\?:\s*true/i.test(lastMsg)) return;
          } else if (filterStep === 'Confirm Failed') {
            if (!/confirmed\?:\s*false/i.test(lastMsg)) return;
          } else if (filterStep === 'Girl Selected') {
            if (!/girl selected|üíï/i.test(lastMsg)) return;
          } else if (filterStep === 'Schedule Selected') {
            if (!/schedule selected|üìÖ/i.test(lastMsg)) return;
          } else if (filterStep === 'Lost at 2 options') {
            // Show only if quit is exactly 'Lost at 2 options'
            if (row.quit !== 'Lost at 2 options') return;
          } else if (filterStep && row.quit !== filterStep) {
            return;
          }
          html += `<tr><td>${row.uid}</td><td>${row.chatId||''}</td><td>${row.ts||''}</td><td class='quit-debug-step'>${row.quit}</td><td class='quit-debug-msg'>${lastMsg}</td></tr>`;
        });
        // Add extra space at the end
        html += `<tr><td colspan='5' style='height:48px;background:none;border:none;'></td></tr>`;
        html += `</table>`;
        document.getElementById('quit-debug').innerHTML = html;
      }
      renderDebugTable();
      // Slicer interactivity
      document.querySelectorAll('.quit-slicer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.quit-slicer-btn').forEach(b=>b.classList.remove('active'));
          if (!btn.classList.contains('clear')) {
            btn.classList.add('active');
            const step = decodeURIComponent(btn.getAttribute('data-step'));
            renderDebugTable(step);
          } else {
            renderDebugTable();
          }
        });
      });
    }

    function drawQuitBar(labels, data) {
      // Sort descending by count
      const zipped = labels.map((l,i)=>({label:l,count:data[i]}));
      zipped.sort((a,b)=>b.count-a.count);
      const sortedLabels = zipped.map(z=>z.label);
      const sortedData = zipped.map(z=>z.count);
      // Draw small chart in dashboard
      const canvas = document.getElementById('quitPie');
      if (canvas) {
        canvas.width = Math.max(canvas.offsetWidth || 0, 320, 400);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const barHeight = 22;
        const gap = 12;
        const chartHeight = sortedLabels.length * (barHeight + gap) + 10;
        canvas.height = chartHeight;
        const max = Math.max(...sortedData, 1);
        const colors = ['#4f8cff','#ffb347','#7ed957','#e0e7ef','#ff6f91','#6fafff','#b2b7c6','#ffb3b3','#ff8c00','#00e6e6','#ff66cc'];
        ctx.font = 'bold 1rem Orbitron, Arial, sans-serif';
        ctx.textBaseline = 'middle';
        for (let i=0; i<sortedLabels.length; i++) {
          const y = 10 + i*(barHeight+gap);
          const barLen = Math.max(10, (sortedData[i]/max)*(canvas.width-120));
          ctx.save();
          ctx.beginPath();
          ctx.fillStyle = colors[i%colors.length];
          ctx.shadowColor = colors[i%colors.length]+'99';
          ctx.shadowBlur = 8;
          ctx.fillRect(110, y, barLen, barHeight);
          ctx.restore();
          // Label
          ctx.fillStyle = '#00f0ff';
          ctx.shadowBlur = 0;
          ctx.fillText(sortedLabels[i], 8, y+barHeight/2);
          // Count
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 1.1rem Orbitron, Arial, sans-serif';
          ctx.fillText(sortedData[i], 120+barLen, y+barHeight/2);
        }
      }
      // Draw large horizontal bar chart after section title
      const barCanvas = document.getElementById('quitPieLarge');
      if (barCanvas) {
        barCanvas.width = Math.max(barCanvas.offsetWidth || 0, 600, 600);
        const ctx = barCanvas.getContext('2d');
        ctx.clearRect(0, 0, barCanvas.width, barCanvas.height);
        const barHeight = 36;
        const gap = 16;
        const leftPad = 220;
        const chartHeight = sortedLabels.length * (barHeight + gap) + 30;
        barCanvas.height = chartHeight;
        const max = Math.max(...sortedData, 1);
        const colors = ['#4f8cff','#ffb347','#7ed957','#e0e7ef','#ff6f91','#6fafff','#b2b7c6','#ffb3b3','#ff8c00','#00e6e6','#ff66cc'];
        ctx.font = 'bold 1.1rem Orbitron, Arial, sans-serif';
        ctx.textBaseline = 'middle';
        let hoveredBar = -1;
        barCanvas.onmousemove = function(e) {
          const rect = barCanvas.getBoundingClientRect();
          const mx = e.clientX - rect.left;
          const my = e.clientY - rect.top;
          let found = -1;
          for (let i=0; i<sortedLabels.length; i++) {
            const y = 18 + i*(barHeight+gap);
            if (my >= y && my <= y+barHeight) { found = i; break; }
          }
          if (hoveredBar !== found) {
            hoveredBar = found;
            drawBars();
          }
        };
        barCanvas.onmouseleave = function() { hoveredBar = -1; drawBars(); };
        function drawBars() {
          ctx.clearRect(0, 0, barCanvas.width, barCanvas.height);
          for (let i=0; i<sortedLabels.length; i++) {
            let y = 18 + i*(barHeight+gap);
            let barH = barHeight;
            let barL = Math.max(30, (sortedData[i]/max)*(barCanvas.width-leftPad-80));
            // If hovered, make the bar bigger
            if (hoveredBar === i) {
              y -= 4;
              barH += 8;
              barL += 18;
            }
            // Label (left, vertically centered, ellipsis if needed)
            ctx.save();
            ctx.fillStyle = hoveredBar === i ? '#fff' : '#00f0ff';
            ctx.shadowBlur = hoveredBar === i ? 16 : 0;
            ctx.shadowColor = hoveredBar === i ? '#00f0ff' : 'transparent';
            ctx.font = 'bold 1.1rem Orbitron, Arial, sans-serif';
            ctx.textAlign = 'right';
            let label = sortedLabels[i];
            let maxLabelWidth = leftPad-18;
            if (ctx.measureText(label).width > maxLabelWidth) {
              while (label.length > 0 && ctx.measureText(label + '...').width > maxLabelWidth) {
                label = label.slice(0, -1);
              }
              label = label + '...';
            }
            ctx.fillText(label, leftPad-18, y+barH/2);
            ctx.restore();
            // Bar
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle = colors[i%colors.length];
            ctx.shadowColor = colors[i%colors.length]+'99';
            ctx.shadowBlur = hoveredBar === i ? 24 : 10;
            ctx.globalAlpha = hoveredBar === i ? 1 : 0.92;
            ctx.fillRect(leftPad, y, barL, barH);
            ctx.restore();
            // Count (right end of bar)
            ctx.save();
            ctx.fillStyle = hoveredBar === i ? '#00f0ff' : '#fff';
            ctx.font = 'bold 1.1rem Orbitron, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.shadowBlur = hoveredBar === i ? 12 : 0;
            ctx.shadowColor = hoveredBar === i ? '#00f0ff' : 'transparent';
            ctx.fillText(sortedData[i], leftPad+barL+12, y+barH/2);
            ctx.restore();
          }
        }
        drawBars();
      }
    }

    // --- Call quit dashboard after main fetch ---
    fetch(normalMessagesUrl)
      .then(res => res.text())
      .then(csvText => {
        const rows = parseCSV(csvText);
        if (rows.length < 2) throw new Error('No data found in normal messages');
        const header = rows[0];
        const colIdx = {
          userId: header.findIndex(h => h.trim().toLowerCase() === 'user id'),
          user: header.findIndex(h => h.trim().toLowerCase() === 'user'),
          response: header.findIndex(h => h.trim().toLowerCase() === 'response'),
          timestamp: header.findIndex(h => h.trim().toLowerCase() === 'timestamp'),
          messageContent: header.findIndex(h => h.trim().toLowerCase() === 'message content'),
        };
        const dataRows = rows.slice(1);
        renderQuitDashboard(dataRows, colIdx);
      })
      .catch(err => {
        document.getElementById('quit-dashboard').innerHTML = '';
        document.getElementById('errorMsg').textContent = 'Failed to load normal messages for quit dashboard: ' + err.message;
      });
  </script>
</body>
</html> 
